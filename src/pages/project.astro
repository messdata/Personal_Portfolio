---
import Particles from "../components/welcome/Particles";
import { supabase } from "../lib/supabase";
import "../styles/responsive.css";

// Fetch only visible projects from Supabase
const { data: projects } = await supabase
  .from("projects")
  .select("*")
  .eq("visible", true)
  .order("created_at", { ascending: false });

// Transform to match the expected format for the frontend
const projectsData = (projects || []).map((project) => ({
  id: project.id,
  title: project.title,
  description: project.description,
  category: project.category.toLowerCase().replace(/\s+/g, "-"), // "Web Development" -> "web-development"
  tools: project.tool_tags || [],
  thumbnailUrl: project.thumbnail_url,
  resourcesLink: project.resources_link || "#",
  slides: project.slides || [],
}));
---

<!doctype html>
<html lang="en" style="margin: 0; padding: 0; height: 100%; overflow: hidden;">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Projects - Chinmay Patil</title>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"
    ></script>

    <!-- Splide CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css"
    />

    <style is:global>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #0a0a0a;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
      }

      /* Floating Navigation - Desktop */
      .floating-nav {
        position: fixed;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      /* Floating Navigation - Mobile */
      @media (max-width: 480px) {
        .floating-nav {
          padding: 0.5rem 0.75rem;
          gap: 0.25rem;
          width: calc(100% - 2rem);
          max-width: 400px;
          justify-content: center;
        }
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 1.5rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
      }

      @media (max-width: 480px) {
        .nav-link {
          padding: 0.4rem 0.6rem;
          font-size: 0.75rem;
        }
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-link.resume {
        border: 1px solid rgba(0, 255, 255, 0.4);
        background: rgba(0, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
      }

      .nav-link.resume:hover {
        background: rgba(0, 255, 255, 0.2);
      }

      .projects-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        overflow-y: auto;
        padding: 6rem 1rem 2rem;
      }

      @media (max-width: 480px) {
        .projects-container {
          padding: 5rem 0.75rem 2rem;
        }
      }

      .projects-wrapper {
        max-width: 1400px;
        margin: 0 auto;
      }

      .projects-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      @media (max-width: 480px) {
        .projects-header {
          margin-bottom: 2rem;
        }
      }

      .projects-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
      }

      @media (min-width: 768px) {
        .projects-title {
          font-size: 3.5rem;
        }
      }

      @media (max-width: 480px) {
        .projects-title {
          font-size: 1.75rem;
        }
      }

      .projects-subtitle {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
      }

      @media (max-width: 480px) {
        .projects-subtitle {
          font-size: 0.75rem;
          margin-bottom: 1.5rem;
          letter-spacing: 0.1em;
        }
      }

      .filter-tabs {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 3rem;
        flex-wrap: wrap;
      }

      @media (max-width: 480px) {
        .filter-tabs {
          gap: 0.35rem;
          margin-bottom: 2rem;
        }
      }

      .filter-tab {
        padding: 0.75rem 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 2rem;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      @media (max-width: 480px) {
        .filter-tab {
          padding: 0.5rem 0.9rem;
          font-size: 0.7rem;
        }
      }

      .filter-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
      }

      .filter-tab.active {
        background: linear-gradient(
          135deg,
          rgba(26, 143, 182, 0.2),
          rgba(13, 244, 244, 0.2)
        );
        border-color: rgba(0, 255, 255, 0.3);
        color: #00ffff;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
      }

      .projects-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
      }

      @media (max-width: 480px) {
        .projects-grid {
          gap: 1.25rem;
          margin-bottom: 2rem;
        }
      }

      @media (min-width: 640px) {
        .projects-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .projects-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      .project-card {
        position: relative;
        height: 400px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: #1a1a1a;
      }

      @media (max-width: 480px) {
        .project-card {
          height: 280px;
        }
      }

      .project-card:hover {
        transform: translateY(-12px) scale(1.02);
      }

      @media (max-width: 768px) {
        .project-card:hover {
          transform: translateY(-6px) scale(1.01);
        }
      }

      .project-card.analytics {
        border-color: rgba(255, 0, 255, 0.3);
      }
      .project-card.web-development,
      .project-card.web {
        border-color: rgba(26, 143, 182, 0.3);
      }
      .project-card.data-science,
      .project-card.academic {
        border-color: rgba(0, 255, 0, 0.3);
      }
      .project-card.other {
        border-color: rgba(255, 255, 0, 0.3);
      }

      .project-card.analytics:hover {
        border-color: rgba(255, 0, 255, 0.6);
        box-shadow: 0 25px 50px rgba(255, 0, 255, 0.4);
      }

      .project-card.web-development:hover,
      .project-card.web:hover {
        border-color: rgba(26, 143, 182, 0.6);
        box-shadow: 0 25px 50px rgba(26, 143, 182, 0.4);
      }

      .project-card.data-science:hover,
      .project-card.academic:hover {
        border-color: rgba(0, 255, 0, 0.6);
        box-shadow: 0 25px 50px rgba(0, 255, 0, 0.4);
      }

      .project-card.other:hover {
        border-color: rgba(255, 255, 0, 0.6);
        box-shadow: 0 25px 50px rgba(255, 255, 0, 0.4);
      }

      .project-card::before,
      .project-card::after {
        position: absolute;
        content: "";
        width: 20%;
        height: 20%;
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 1;
      }

      .project-card::before {
        top: 0;
        right: 0;
        border-radius: 0 0.75rem 0 100%;
      }

      .project-card::after {
        bottom: 0;
        left: 0;
        border-radius: 0 100% 0 0.75rem;
      }

      .project-card.analytics::before,
      .project-card.analytics::after {
        background: rgba(255, 0, 255, 0.9);
      }

      .project-card.web-development::before,
      .project-card.web-development::after,
      .project-card.web::before,
      .project-card.web::after {
        background: rgba(26, 143, 182, 0.9);
      }

      .project-card.data-science::before,
      .project-card.data-science::after,
      .project-card.academic::before,
      .project-card.academic::after {
        background: rgba(0, 255, 0, 0.9);
      }

      .project-card.other::before,
      .project-card.other::after {
        background: rgba(255, 255, 0, 0.9);
      }

      .project-card:hover::before,
      .project-card:hover::after {
        width: 100%;
        height: 100%;
        border-radius: 0.75rem;
      }

      .project-content {
        position: absolute;
        inset: 0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        z-index: 2;
        opacity: 0;
        transition: opacity 0.3s ease 0.2s;
      }

      @media (max-width: 480px) {
        .project-content {
          padding: 1rem;
        }
      }

      .project-card:hover .project-content {
        opacity: 1;
      }

      .project-category {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 1rem;
        width: fit-content;
      }

      @media (max-width: 480px) {
        .project-category {
          padding: 0.35rem 0.75rem;
          font-size: 0.65rem;
          margin-bottom: 0.5rem;
        }
      }

      .project-category.analytics {
        background: rgba(255, 0, 255, 0.2);
        border: 1px solid rgba(255, 0, 255, 0.5);
        color: #ff00ff;
      }

      .project-category.web-development,
      .project-category.web {
        background: rgba(26, 143, 182, 0.2);
        border: 1px solid rgba(26, 143, 182, 0.5);
        color: #1a8fb6;
      }

      .project-category.data-science,
      .project-category.academic {
        background: rgba(0, 255, 0, 0.2);
        border: 1px solid rgba(0, 255, 0, 0.5);
        color: #00ff00;
      }

      .project-category.other {
        background: rgba(255, 255, 0, 0.2);
        border: 1px solid rgba(255, 255, 0, 0.5);
        color: #ffff00;
      }

      .project-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.75rem;
      }

      @media (max-width: 480px) {
        .project-name {
          font-size: 1.125rem;
          margin-bottom: 0.5rem;
        }
      }

      .project-description {
        font-size: 0.875rem;
        line-height: 1;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 1rem;
      }

      @media (max-width: 480px) {
        .project-description {
          font-size: 0.75rem;
          line-height: 1.4;
          margin-bottom: 0.5rem;
          display: -webkit-box;
          -webkit-line-clamp: 3;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }
      }

      /* .project-tools {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        font-weight: 500;
      } */

      /* @media (max-width: 480px) {
        .project-tools {
          font-size: 0.65rem;
        }
      } */

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        z-index: 9999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .modal-overlay.active {
        display: flex;
        opacity: 1;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      @media (max-width: 480px) {
        .modal-overlay.active {
          padding: 0.75rem;
          align-items: flex-start;
          padding-top: 1rem;
        }
      }

      .modal-overlay.closing {
        opacity: 0;
      }

      .modal-container {
        background: rgba(10, 10, 10, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        width: 100%;
        max-width: 1200px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      @media (max-width: 480px) {
        .modal-container {
          max-height: 95vh;
          border-radius: 0.75rem;
        }
      }

      .modal-header {
        padding: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
      }

      @media (max-width: 768px) {
        .modal-header {
          flex-direction: column;
          padding: 1.25rem;
          gap: 1rem;
        }
      }

      .modal-title-section {
        flex: 1;
      }

      .modal-header h2 {
        font-size: 2rem;
        color: white;
        margin-bottom: 0.5rem;
      }

      @media (max-width: 480px) {
        .modal-header h2 {
          font-size: 1.25rem;
        }
      }

      .modal-header p {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.6);
      }

      @media (max-width: 480px) {
        .modal-header p {
          font-size: 0.75rem;
        }
      }

      .modal-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      @media (max-width: 768px) {
        .modal-actions {
          width: 100%;
          justify-content: space-between;
        }
      }

      .download-btn {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #00ffff, #00ff00);
        color: #0a0a0a;
        text-decoration: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      @media (max-width: 480px) {
        .download-btn {
          padding: 0.6rem 1rem;
          font-size: 0.75rem;
        }
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 255, 255, 0.3);
      }

      .close-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      @media (max-width: 480px) {
        .close-btn {
          width: 36px;
          height: 36px;
          font-size: 1.25rem;
        }
      }

      .close-btn:hover {
        background: rgba(255, 0, 0, 0.2);
        border-color: #ff0000;
      }

      .splide-container {
        flex: 1;
        overflow: hidden;
        padding: 2rem;
      }

      @media (max-width: 480px) {
        .splide-container {
          padding: 1rem;
        }
      }

      .slide-card {
        background: rgba(255, 255, 255, 0.02);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        overflow: hidden;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .slide-card__img {
        width: 100%;
        height: 400px;
        object-fit: cover;
      }

      @media (max-width: 768px) {
        .slide-card__img {
          height: 250px;
        }
      }

      @media (max-width: 480px) {
        .slide-card__img {
          height: 180px;
        }
      }

      .slide-card__content {
        padding: 2rem;
        flex: 1;
      }

      @media (max-width: 480px) {
        .slide-card__content {
          padding: 1rem;
        }
      }

      .slide-card__content h3 {
        font-size: 1.5rem;
        color: white;
        margin-bottom: 1rem;
      }

      @media (max-width: 480px) {
        .slide-card__content h3 {
          font-size: 1rem;
          margin-bottom: 0.5rem;
        }
      }

      .slide-card__content p {
        font-size: 1rem;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.7);
      }

      @media (max-width: 480px) {
        .slide-card__content p {
          font-size: 0.8rem;
          line-height: 1.4;
        }
      }

      .modal-footer {
        padding: 1.5rem 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: center;
      }

      @media (max-width: 480px) {
        .modal-footer {
          padding: 1rem;
        }
      }

      .slide-counter {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.875rem;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: rgba(255, 255, 255, 0.6);
      }

      @media (max-width: 480px) {
        .empty-state {
          padding: 2rem 1rem;
        }
      }

      .empty-state h3 {
        font-size: 1.5rem;
        color: white;
        margin-bottom: 0.5rem;
      }

      @media (max-width: 480px) {
        .empty-state h3 {
          font-size: 1.125rem;
        }
      }
    </style>
  </head>

  <body>
    <Particles client:load />

    <nav class="floating-nav">
      <a
        href="/"
        class="nav-link"
        onclick="sessionStorage.setItem('skipIntro', 'true')">Home</a
      >
      <a href="/about" class="nav-link">About</a>
      <a href="/contact" class="nav-link">Contact</a>
      <a href="/cv" class="nav-link resume">Resume</a>
    </nav>

    <div class="projects-container">
      <div class="projects-wrapper">
        <header class="projects-header">
          <h1 class="projects-title">Projects Portfolio</h1>
          <p class="projects-subtitle">Data Analytics Â· Case Studies</p>
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all"
              >All Projects</button
            >
            <button class="filter-tab" data-filter="analytics">Analytics</button
            >
          </div>
        </header>
        <div class="projects-grid" id="projects-grid"></div>
      </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <div class="modal-title-section">
            <h2 id="modal-title">Project Title</h2>
            <p id="modal-tools">Tools: Excel, Tableau</p>
          </div>
          <div class="modal-actions">
            <a href="#" id="download-resources" class="download-btn"
              >Download Resources</a
            >
            <button class="close-btn" id="close-modal">&times;</button>
          </div>
        </div>
        <div class="splide-container">
          <div class="splide" id="project-splide">
            <div class="splide__track">
              <ul class="splide__list" id="splide-slides"></ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <span class="slide-counter" id="slide-counter">1 / 5</span>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"
    ></script>

    <script define:vars={{ projectsData }}>
      // Projects data from Supabase (passed from Astro)
      const projects = projectsData;

      function renderProjects(filter = "all") {
        const grid = document.getElementById("projects-grid");

        if (projects.length === 0) {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
              <h3>No projects yet</h3>
              <p>Check back soon for updates!</p>
            </div>
          `;
          return;
        }

        const filtered =
          filter === "all"
            ? projects
            : projects.filter((p) => p.category === filter);

        if (filtered.length === 0) {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
              <h3>No projects in this category</h3>
              <p>Try selecting a different filter</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = filtered
          .map((project) => {
            return `
            <div class="project-card ${project.category}" data-project-id="${project.id}" 
                 style="background-image: url('${project.thumbnailUrl}');">
              <div class="project-content">
                <span class="project-category ${project.category}">${project.category.replace("-", " ")}</span>
                <h3 class="project-name">${project.title}</h3>
                <p class="project-description">${project.description}</p>
                
              </div>
            </div>
          `;
          })
          .join("");

        document.querySelectorAll(".project-card").forEach((card) => {
          card.addEventListener("click", () =>
            openProject(card.dataset.projectId),
          );
        });
      }

      let currentSplide = null;

      function openProject(projectId) {
        const project = projects.find((p) => p.id === projectId);
        if (!project) return;

        document.getElementById("modal-title").textContent = project.title;
        document.getElementById("modal-tools").textContent =
          `Tools: ${project.tools.join(", ")}`;
        document.getElementById("download-resources").href =
          project.resourcesLink;

        if (project.slides.length === 0) {
          document.getElementById("splide-slides").innerHTML = `
            <li class="splide__slide">
              <div class="slide-card ${project.category}">
                <div class="slide-card__content" style="padding: 4rem; text-align: center;">
                  <h3>No slides available</h3>
                  <p>This project doesn't have any slides yet.</p>
                </div>
              </div>
            </li>
          `;
        } else {
          document.getElementById("splide-slides").innerHTML = project.slides
            .map(
              (slide) => `
            <li class="splide__slide">
              <div class="slide-card ${project.category}">
                <img src="${slide.imageUrl}" alt="${slide.title}" class="slide-card__img" />
                <div class="slide-card__content">
                  <h3>${slide.title}</h3>
                  <p>${slide.description}</p>
                </div>
              </div>
            </li>
          `,
            )
            .join("");
        }

        document.getElementById("modal-overlay").classList.add("active");
        document.body.style.overflow = "hidden";

        if (currentSplide) currentSplide.destroy();

        currentSplide = new Splide("#project-splide", {
          type: "slide",
          perPage: 1,
          gap: "2rem",
          arrows: true,
          pagination: true,
          keyboard: true,
        }).mount();

        currentSplide.on("moved", (newIndex) => {
          updateCounter(newIndex + 1, project.slides.length || 1);
        });

        updateCounter(1, project.slides.length || 1);
      }

      function updateCounter(current, total) {
        document.getElementById("slide-counter").textContent =
          `${current} / ${total}`;
      }

      function closeModal() {
        const modalOverlay = document.getElementById("modal-overlay");
        modalOverlay.classList.add("closing");
        setTimeout(() => {
          modalOverlay.classList.remove("active", "closing");
          if (currentSplide) {
            currentSplide.destroy();
            currentSplide = null;
          }
          document.body.style.overflow = "";
        }, 300);
      }

      document.querySelectorAll(".filter-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".filter-tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          renderProjects(tab.dataset.filter);
        });
      });

      document
        .getElementById("close-modal")
        .addEventListener("click", closeModal);
      document
        .getElementById("modal-overlay")
        .addEventListener("click", (e) => {
          if (e.target === document.getElementById("modal-overlay"))
            closeModal();
        });

      document.addEventListener("keydown", (e) => {
        if (
          !document.getElementById("modal-overlay").classList.contains("active")
        )
          return;
        if (e.key === "Escape") closeModal();
      });

      renderProjects();
    </script>
  </body>
</html>
